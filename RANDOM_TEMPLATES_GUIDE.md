# Руководство по использованию случайных шаблонов

## Обзор

Система генерации изображений теперь поддерживает **случайный выбор шаблонов** из папки `images/new_templates`. Это позволяет каждому пользователю получить уникальную новогоднюю фигурку из набора доступных вариантов.

## Структура папок

```
images/
├── templates/              # Старые шаблоны (fallback)
│   ├── figure_male.png
│   └── figure_female.png
│
└── new_templates/          # Новые шаблоны (используются по умолчанию)
    ├── figure_male1.png    (1028 KB)
    ├── figure_male2.png    (894 KB)
    ├── figure_male3.png    (1202 KB)
    ├── figure_male4.png    (1199 KB)
    ├── figure_female1.png  (977 KB)
    ├── figure_female2.png  (883 KB)
    ├── figure_female3.png  (1222 KB)
    └── figure_female4.png  (1357 KB)
```

## Как это работает

### 1. Случайный выбор

При генерации изображения система:
1. Определяет пол пользователя (`male` или `female`)
2. Ищет все шаблоны в `images/new_templates/` с паттерном `figure_{gender}*.png`
3. **Случайно выбирает** один из найденных шаблонов
4. Использует выбранный шаблон для генерации

### 2. Fallback механизм

Если шаблоны не найдены в `new_templates/`:
- Система автоматически переключается на старые шаблоны из `images/templates/`
- Выдается предупреждение в логи
- Генерация продолжается без ошибок

## Добавление новых шаблонов

### Требования к именованию

Шаблоны **должны** следовать паттерну:
- Мужские: `figure_male*.png` (например: `figure_male1.png`, `figure_male_santa.png`)
- Женские: `figure_female*.png` (например: `figure_female1.png`, `figure_female_elf.png`)

### Как добавить новый шаблон

1. Подготовьте PNG-изображение с прозрачным фоном
2. Убедитесь, что область головы пустая (для наложения лица)
3. Назовите файл согласно паттерну (например, `figure_male5.png`)
4. Поместите в `images/new_templates/`
5. Перезапустите бота (или он подхватит при следующей генерации)

**Примеры правильных имен:**
- ✅ `figure_male1.png`
- ✅ `figure_male5.png`
- ✅ `figure_male_santa.png`
- ✅ `figure_female1.png`
- ✅ `figure_female_elf.png`

**Примеры неправильных имен:**
- ❌ `male_figure.png` (неправильный порядок)
- ❌ `figure_m1.png` (не соответствует паттерну)
- ❌ `template_male.png` (неправильное начало)

## Тестирование

### Запуск теста

```bash
python test_random_templates.py
```

### Что проверяет тест

1. **Случайность выбора** - делает 10 выборок для каждого пола
2. **Распределение** - показывает статистику использования каждого шаблона
3. **Наличие файлов** - проверяет существование всех шаблонов
4. **Размеры файлов** - выводит размер каждого шаблона

### Пример вывода теста

```
[MALE] Testing MALE templates (10 selections):
  1. figure_male1.png
  2. figure_male4.png
  3. figure_male2.png
  ...

[STATS] Male template distribution:
  figure_male1.png: 3 times
  figure_male2.png: 2 times
  figure_male3.png: 2 times
  figure_male4.png: 3 times

[FILES] Available templates:
  Male templates (4):
    [OK] figure_male1.png (1028.9 KB)
    [OK] figure_male2.png (894.1 KB)
    ...
```

## Технические детали

### Реализация

Файл: `services/template_generator.py`

#### Ключевой метод

```python
def _get_random_template(self, gender: str) -> Path:
    """Get random template from new_templates directory."""
    pattern = f"figure_{gender}*.png"
    templates = list(self.new_templates_dir.glob(pattern))

    if not templates:
        # Fallback to old templates
        return self.male_template if gender == "male" else self.female_template

    # Random selection
    selected = random.choice(templates)
    return selected
```

### Логирование

Система логирует каждый выбор:
```
INFO - Selected random template for male: figure_male3.png
INFO - Using template: images/new_templates/figure_male3.png
```

## Преимущества

### ✅ Разнообразие
- Каждый пользователь может получить уникальный вариант фигурки
- Снижает вероятность получения одинаковых изображений

### ✅ Масштабируемость
- Легко добавить новые шаблоны без изменения кода
- Просто поместите файл в папку и перезапустите бота

### ✅ Надежность
- Fallback на старые шаблоны при отсутствии новых
- Система продолжает работать даже если один шаблон поврежден

### ✅ Гибкость
- Поддержка любого количества шаблонов
- Можно добавлять тематические варианты (Санта, эльф, снеговик и т.д.)

## Статистика использования

При текущей конфигурации (4 мужских + 4 женских):
- **Вероятность уникального изображения** для двух пользователей: ~87.5% (7/8)
- **Среднее количество повторений** на 100 пользователей: ~12-13 раз на шаблон

## Рекомендации

### Для лучшего пользовательского опыта

1. **Минимум 3-4 шаблона** на каждый пол
2. **Разнообразие дизайнов** - разные позы, наряды, аксессуары
3. **Одинаковое качество** всех шаблонов
4. **Единый стиль** - чтобы все выглядели как набор

### Оптимизация производительности

- Размер файлов: **~800-1400 KB** оптимален
- Формат: **PNG** с прозрачностью
- Разрешение: **765x1360px** (или аналогичное соотношение)

## Устранение неполадок

### Шаблоны не загружаются

1. Проверьте имя файла (должно быть `figure_{gender}*.png`)
2. Убедитесь, что файл в правильной папке (`images/new_templates/`)
3. Проверьте права доступа к файлу
4. Посмотрите логи бота на наличие ошибок

### Всегда выбирается один шаблон

1. Убедитесь, что есть несколько файлов для каждого пола
2. Проверьте логи - система должна показывать случайный выбор
3. Перезапустите бота

### Генерация не работает

1. Проверьте, что хотя бы один шаблон существует
2. Убедитесь, что старые шаблоны есть в `images/templates/` (fallback)
3. Проверьте логи на наличие ошибок загрузки изображений

## Обновления и расширения

### Добавление тематических наборов

Можно создать несколько тематических вариантов:
```
figure_male_santa.png     # Санта
figure_male_elf.png       # Эльф
figure_male_snowman.png   # Снеговик
figure_female_angel.png   # Ангел
figure_female_fairy.png   # Фея
```

Все они будут автоматически участвовать в случайном выборе!

---

**Создано:** 2025-12-28
**Версия:** 1.0
**Статус:** ✅ Протестировано и работает
