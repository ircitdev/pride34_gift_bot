# Структура проекта Pride34 Gift Bot

```
pride34_gift_bot/
│
├── .env                      # Конфигурация бота (НЕ коммитить в Git!)
├── .env.example              # Пример конфигурации
├── .gitignore                # Игнорируемые Git файлы
├── config.py                 # Настройки приложения
├── main.py                   # Точка входа в приложение
├── requirements.txt          # Python зависимости
├── README.md                 # Основная документация
├── INSTALL.md                # Инструкция по установке
├── USAGE.md                  # Руководство пользователя
├── PROJECT_STRUCTURE.md      # Этот файл
│
├── bot/                      # Основные компоненты бота
│   ├── __init__.py
│   ├── keyboards.py          # Клавиатуры (inline и reply)
│   ├── states.py             # FSM состояния
│   └── quiz_data.py          # Данные квиза и предсказания
│
├── handlers/                 # Обработчики команд и событий
│   ├── __init__.py
│   ├── start.py              # Обработчик /start
│   ├── quiz.py               # Обработчик квиза
│   ├── photo.py              # Обработчик фото и выбора пола
│   └── admin.py              # Админ-панель
│
├── database/                 # Работа с базой данных
│   ├── __init__.py
│   ├── models.py             # SQLAlchemy модели
│   ├── engine.py             # Подключение к БД
│   └── crud.py               # CRUD операции
│
├── services/                 # Бизнес-логика
│   ├── __init__.py
│   └── image_processor.py    # Обработка и генерация изображений
│
├── utils/                    # Вспомогательные функции
│   └── __init__.py
│
├── images/                   # Изображения бота
│   ├── welcome.jpg           # Приветственное изображение (добавить вручную)
│   └── templates/            # Шаблоны фигурок
│       ├── figure_male.png   # Шаблон мужской фигурки (опционально)
│       └── figure_female.png # Шаблон женской фигурки (опционально)
│
├── user_photos/              # Загруженные фото пользователей
│   └── (генерируется автоматически)
│
├── generated_photos/         # Сгенерированные изображения
│   └── (генерируется автоматически)
│
└── bot.db                    # SQLite база данных (создаётся автоматически)
```

## Описание модулей

### Конфигурация

**config.py**
- Управление настройками через переменные окружения
- Валидация параметров с помощью Pydantic
- Создание необходимых директорий

**.env**
- Токен бота
- ID администраторов
- Настройки базы данных
- Параметры квиза и розыгрыша

### Основное приложение

**main.py**
- Инициализация бота и диспетчера
- Регистрация роутеров
- Настройка логирования
- Запуск polling

### Бот компоненты

**bot/keyboards.py**
- `get_start_keyboard()` - кнопка начала квиза
- `get_gender_keyboard()` - выбор пола
- `get_quiz_keyboard()` - кнопки ответов квиза
- `get_share_keyboard()` - поделиться результатом
- `get_admin_keyboard()` - админ-панель

**bot/states.py**
- FSM состояния для управления flow пользователя
- Состояния квиза (вопросы 1-5)
- Состояния ожидания пола и фото

**bot/quiz_data.py**
- Вопросы квиза (5 штук)
- Варианты ответов
- Генерация предсказаний на основе ответов

### Обработчики

**handlers/start.py**
- Команда `/start`
- Приветственное сообщение с изображением
- Регистрация пользователя в БД
- Начало квиза

**handlers/quiz.py**
- Отправка вопросов квиза
- Обработка ответов пользователя
- Сохранение ответов в БД
- Индикатор прогресса

**handlers/photo.py**
- Запрос выбора пола
- Обработка выбора пола
- Загрузка фото от пользователя
- Генерация персонального изображения
- Отправка финального результата

**handlers/admin.py**
- Команда `/admin`
- Статистика участников
- Проведение розыгрыша
- Список победителей
- Экспорт данных в CSV

### База данных

**database/models.py**
- `User` - информация о пользователях
- `QuizAnswer` - ответы на вопросы квиза
- `UserPhoto` - загруженные и сгенерированные фото
- `QuizQuestion` - вопросы квиза (опционально)

**database/engine.py**
- Асинхронный движок SQLAlchemy
- Создание сессий
- Инициализация таблиц

**database/crud.py**
- `UserCRUD` - операции с пользователями
- `QuizAnswerCRUD` - операции с ответами
- `UserPhotoCRUD` - операции с фото
- `QuizQuestionCRUD` - операции с вопросами

### Сервисы

**services/image_processor.py**
- `ImageProcessor` - класс обработки изображений
- Определение лица на фото (OpenCV)
- Создание круговой обрезки
- Наложение лица на шаблон фигурки
- Генерация placeholder изображений

## Технологии

- **aiogram 3.x** - Telegram Bot Framework
- **SQLAlchemy 2.0** - ORM для работы с БД
- **Pillow** - обработка изображений
- **OpenCV** - определение лиц
- **Pydantic** - валидация настроек
- **aiosqlite** - асинхронная работа с SQLite

## Workflow пользователя

1. `/start` → Приветствие
2. Кнопка "Начать квиз" → Вопрос 1/5
3. Ответ → Вопрос 2/5
4. ... → Вопрос 5/5
5. Ответ → Выбор пола
6. Выбор пола → Запрос фото
7. Загрузка фото → Обработка изображения
8. Генерация → Результат + Предсказание + Участие в розыгрыше

## Workflow администратора

1. `/admin` → Админ-панель
2. Статистика → Просмотр данных
3. Розыгрыш → Выбор победителей (один раз)
4. Победители → Список ID победителей
5. Экспорт данных → CSV файл

## База данных

### Таблица users
- id (PK) - Telegram ID
- username - имя пользователя
- full_name - полное имя
- created_at - дата регистрации
- quiz_completed - завершён ли квиз
- photo_uploaded - загружено ли фото
- gender - пол (male/female)
- is_winner - победитель или нет

### Таблица quiz_answers
- id (PK, autoincrement)
- user_id (FK) - ID пользователя
- question_number - номер вопроса (1-5)
- answer - текст ответа
- created_at - дата ответа

### Таблица user_photos
- id (PK, autoincrement)
- user_id (FK, unique) - ID пользователя
- file_id - Telegram file ID
- file_path - путь к загруженному фото
- generated_path - путь к сгенерированному фото
- created_at - дата загрузки

## Безопасность

- Токен бота хранится в `.env` (не в Git)
- ID администраторов проверяются перед доступом
- Фото пользователей изолированы в отдельных папках
- База данных SQLite с правами доступа

## Масштабирование

Для большого количества пользователей:
1. Замените SQLite на PostgreSQL
2. Используйте Redis для кеширования
3. Разделите обработку изображений на отдельный worker
4. Используйте webhooks вместо polling

## Резервное копирование

Регулярно создавайте копии:
- `bot.db` - база данных
- `user_photos/` - фото пользователей
- `generated_photos/` - сгенерированные изображения
