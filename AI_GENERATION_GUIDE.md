# AI Generation Guide - Pride34 Gift Bot

## Обзор

Бот теперь использует **DALL-E 3** от OpenAI для создания профессиональных 3D-фигурок, как у конкурентов.

## Как это работает

### 1. Генерация базовой фигурки (DALL-E 3)
- Создается фотореалистичный 3D-рендер фигурки на новогоднем фоне
- Используются оптимизированные промпты для максимального качества
- Стиль: коллекционная игрушка (Funko Pop / Disney aesthetic)
- Формат: портретная ориентация 1024x1792px

### 2. Наложение лица (Face Swapping)
- Автоматическая детекция лица на фото пользователя
- Реалистичное наложение с плавными переходами
- Сохранение освещения и перспективы

### 3. Fallback механизм
- Если AI-генерация недоступна → используется шаблонный метод
- Если face-swapping не работает → пропускается этап
- Всегда есть резервный вариант генерации

## Настройка

### Конфигурация (.env)

```bash
# AI Generation
OPENAI_API_KEY=your_openai_api_key_here
AI_GENERATION_ENABLED=true
```

### Параметры

- `AI_GENERATION_ENABLED` - включить/выключить AI-генерацию (default: true)
- `OPENAI_API_KEY` - API ключ OpenAI для DALL-E 3

## Использование

### Автоматически в боте

Бот автоматически использует AI-генерацию для всех пользователей:

```python
# handlers/photo.py
result = await image_processor.create_christmas_figure(
    user_photo_path=photo_path,
    gender=user_gender,
    user_id=user_id
)
```

### Тестирование

Запустите тестовый скрипт:

```bash
python test_generation.py
```

Убедитесь, что файл `testphoto.jpg` находится в корне проекта.

## Стоимость

### DALL-E 3 Pricing (OpenAI)

- **HD Quality (1024x1792)**: ~$0.080 за изображение
- **Standard Quality**: ~$0.040 за изображение

**Текущие настройки:** HD Quality для максимального качества

### Расчет бюджета

Для 1000 пользователей:
- 1000 изображений × $0.080 = **$80**

Для 30 победителей (как в квизе):
- 30 изображений × $0.080 = **$2.40**

## Оптимизация промптов

Промпты следуют best practices от OpenAI:

### Структура промпта

```
BACKGROUND → SUBJECT → DETAILS → CONSTRAINTS
```

### Ключевые элементы

1. **Material realism**: "glossy vinyl material", "surface texture"
2. **Photography terms**: "85mm lens feel", "f/2.8 aperture effect"
3. **Composition**: "shallow depth of field", "bokeh lights"
4. **Style reference**: "Funko Pop / Disney collectible aesthetic"
5. **Constraints**: "No watermarks", "no cartoon style"

## Примеры результатов

### Male Figurine
- Спортивный костюм с синими и оранжевыми полосами
- Фитнес-поза
- Золотой крючок для подвешивания
- Логотип PRIDE34 внизу

### Female Figurine
- Спортивная одежда для фитнеса
- Элегантная поза
- Те же характеристики качества

## Troubleshooting

### API ошибки

**Ошибка 401**: Неверный API ключ
```bash
# Проверьте .env файл
OPENAI_API_KEY=sk-proj-...
```

**Ошибка 429**: Превышен лимит запросов
- Используйте rate limiting в боте
- Рассмотрите очередь обработки

**Ошибка 400**: Проблема с промптом
- Проверьте логи для деталей
- Промпт может содержать запрещенный контент

### Качество генерации

**Лицо не похоже**:
- Face swapping работает лучше на четких фронтальных фото
- Проверьте качество исходного фото

**Фон не новогодний**:
- Промпт оптимизирован для новогодней тематики
- При необходимости измените в `ai_generator.py`

**Нет логотипа PRIDE34**:
- DALL-E 3 иногда игнорирует текстовые элементы
- Можно добавить логотип постобработкой

## Расширенные возможности

### Кастомизация промптов

Отредактируйте метод `_create_prompt()` в [services/ai_generator.py](services/ai_generator.py:65):

```python
def _create_prompt(self, gender: str) -> str:
    # Измените одежду
    gender_clothing = {
        "male": "red Santa outfit with white trim",
        "female": "elegant snow queen dress"
    }
    # ... остальной код
```

### Добавление вариантов

Можно генерировать несколько вариантов:

```python
# В ai_generator.py измените:
payload = {
    "n": 3,  # Генерировать 3 варианта
    # ...
}
```

**Внимание**: Стоимость умножается на количество вариантов!

### Постобработка

Добавьте дополнительные эффекты после генерации:

```python
# В image_processor.py после face swapping
result = await self._add_special_effects(final_image)
```

## Сравнение с конкурентами

### Конкурент (пример: example_gift.jpg)
- ✓ 3D-рендер высокого качества
- ✓ Профессиональный фон
- ✓ Реалистичная фигурка
- ✓ Детализированная одежда

### Pride34 Bot (с AI)
- ✓ 3D-рендер высокого качества (DALL-E 3)
- ✓ Профессиональный новогодний фон
- ✓ Реалистичная фигурка
- ✓ Спортивная одежда PRIDE34
- ✓ Автоматическое наложение лица
- ✓ Брендинг PRIDE34

## Следующие шаги

1. **Протестируйте генерацию**: `python test_generation.py`
2. **Проверьте результаты**: папка `generated_photos/`
3. **Настройте промпты** под ваши требования
4. **Оптимизируйте costs** при необходимости
5. **Добавьте в бота** дополнительные варианты

## Поддержка

Логи находятся в консоли с уровнем INFO/ERROR.

Для детальной отладки измените в `test_generation.py`:

```python
logging.basicConfig(level=logging.DEBUG)
```
