# Face Swapper Improvements - v2.4.0

**–î–∞—Ç–∞:** 2025-12-29
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## –û–±–∑–æ—Ä

–£–ª—É—á—à–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–∞–º–µ–Ω—ã –ª–∏—Ü –≤ `services/face_swapper.py` —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

---

## –ü—Ä–æ–±–ª–µ–º—ã –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ

### 1. ‚ùå –û–ø–µ—á–∞—Ç–∫–∞ –≤ padding —Ä–∞—Å—á—ë—Ç–µ (_extract_face_region)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä–æ–∫–∏ 88-95
```python
# –ë–´–õ–û:
padding = int(w * 0.2)
x = max(0, x - padding)          # –¢–µ—Ä—è–µ—Ç –ª–µ–≤—ã–π padding
y = max(0, y - padding)          # –¢–µ—Ä—è–µ—Ç –≤–µ—Ä—Ö–Ω–∏–π padding
w = min(img.shape[1] - x, w + 2 * padding)  # –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π padding
h = min(img.shape[0] - y, h + 2 * padding)  # –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π padding
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –õ–∏—Ü–æ —Å–º–µ—â–µ–Ω–æ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –µ—Å–ª–∏ —É –∫—Ä–∞—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –°–¢–ê–õ–û:
padding_w = int(w * 0.3)
padding_h = int(h * 0.4)

x_start = max(0, x - padding_w)
y_start = max(0, y - padding_h)
x_end = min(img.shape[1], x + w + padding_w)
y_end = min(img.shape[0], y + h + padding_h)

return img[y_start:y_end, x_start:x_end]
```

---

### 2. ‚ùå –ò—Å–∫–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –ª–∏—Ü–∞ (_blend_faces)

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä–æ–∫–∏ 128-145
```python
# –ë–´–õ–û:
expand_factor = 1.5
new_w = int(w * expand_factor)    # –†–∞—Å—à–∏—Ä—è–µ–º —à–∏—Ä–∏–Ω—É
new_h = int(h * expand_factor)    # –†–∞—Å—à–∏—Ä—è–µ–º –≤—ã—Å–æ—Ç—É
# –ü—Ä–æ–±–ª–µ–º–∞: –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è aspect ratio –ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ö—Ä—É–≥–ª—ã–µ –ª–∏—Ü–∞ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –≤—ã—Ç—è–Ω—É—Ç—ã–º–∏, –≤—ã—Ç—è–Ω—É—Ç—ã–µ - —Å–ø–ª—é—Å–Ω—É—Ç—ã–º–∏

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –°–¢–ê–õ–û:
target_w = int(w * expand_factor)
# PRESERVE ASPECT RATIO
face_h, face_w = face_img.shape[:2]
aspect_ratio = face_w / face_h
target_h = int(target_w / aspect_ratio)  # –í—ã—Å–æ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–π!
```

---

### 3. ‚ùå –°–ª–∞–±–∞—è —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç—Ä–æ–∫–∏ 151-160
```python
# –ë–´–õ–û:
for i in range(3):
    face_mean = face_lab[:, :, i].mean()
    roi_mean = roi_lab[:, :, i].mean()
    # –¢–æ–ª—å–∫–æ —Å–º–µ—â–µ–Ω–∏–µ mean, –±–µ–∑ —É—á—ë—Ç–∞ std
    face_lab[:, :, i] = np.clip(face_lab[:, :, i] + (roi_mean - face_mean) * 0.3, 0, 255)
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ü–ª–æ—Ö–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ —Å–∏–ª—å–Ω—ã—Ö —Ä–∞–∑–ª–∏—á–∏—è—Ö –æ—Å–≤–µ—â–µ–Ω–∏—è

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ú–µ—Ç–æ–¥ –∏–∑ template_generator.py
```python
# –°–¢–ê–õ–û:
for i in range(3):
    face_mean = face_lab[:, :, i].mean()
    face_std = face_lab[:, :, i].std()
    roi_mean = roi_lab[:, :, i].mean()
    roi_std = roi_lab[:, :, i].std()

    # Adjust both mean AND std
    face_lab[:, :, i] = (
        (face_lab[:, :, i] - face_mean) * (roi_std / (face_std + 1e-6))
        + roi_mean
    )
```

---

### 4. ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ profile detection

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `haarcascade_frontalface_default.xml`

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –ù–µ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –ª–∏—Ü–∞ –≤ –ø—Ä–æ—Ñ–∏–ª—å –∏–ª–∏ –ø–æ–¥ —É–≥–ª–æ–º

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–ª–µ–Ω–æ:
self.profile_cascade = cv2.CascadeClassifier(
    cv_data + 'haarcascade_profileface.xml'
)

# Try frontal first, then profile
faces = self.frontal_cascade.detectMultiScale(...)
if len(faces) == 0 and not self.profile_cascade.empty():
    faces = self.profile_cascade.detectMultiScale(...)
```

---

### 5. ‚ùå –ù–µ—Ç Seamless Cloning (Poisson Blending)

**–ü—Ä–æ–±–ª–µ–º–∞:** –†—É—á–Ω–æ–µ —Å–º–µ—à–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ LAB + Gaussian blur

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:** –í–∏–¥–Ω—ã —à–≤—ã, –Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω `cv2.seamlessClone`
```python
# –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ _seamless_blend_faces():
result = cv2.seamlessClone(
    face_resized,
    base_img,
    mask,
    dest_center,
    cv2.NORMAL_CLONE  # Poisson Blending
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ seamlessClone:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ—Å–≤–µ—â–µ–Ω–∏–µ
- –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ "–≤–∂–∏–≤–ª—è–µ—Ç" –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –ª–∏—Ü–∞ –≤ —Å—Ü–µ–Ω—É
- –ë–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –ù–µ–∑–∞–º–µ—Ç–Ω—ã–µ —à–≤—ã

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ª—É—á—à–µ–Ω–∏–π

### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã

**1. `_seamless_blend_faces()` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥**
- Preserves aspect ratio
- Uses cv2.seamlessClone (Poisson Blending)
- Proper bounds checking
- Elliptical mask for natural edges

**2. `_fallback_blend()` - —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ seamlessClone fails
- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è (mean + std)
- Soft alpha blending

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã

**3. `_extract_face_region()` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω padding**
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –≥—Ä–∞–Ω–∏—Ü
- Profile cascade fallback
- 30% horizontal / 40% vertical padding

**4. `_detect_face_region()` - –¥–æ–±–∞–≤–ª–µ–Ω profile**
- Frontal cascade first
- Profile cascade fallback
- Better angle coverage

---

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –¥–æ –∏ –ø–æ—Å–ª–µ

### –ë—ã–ª–æ (v2.3.2)
```python
# –°—Ç–∞—Ä—ã–π _blend_faces():
- –ò—Å–∫–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π (–∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è —ç–∫—Å–ø–∞–Ω—Å–∏—è)
- –ü—Ä–æ—Å—Ç–∞—è LAB —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è (—Ç–æ–ª—å–∫–æ mean)
- Gaussian blur –¥–ª—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è
- –í–∏–¥–Ω—ã —à–≤—ã –Ω–∞ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ö
```

### –°—Ç–∞–ª–æ (v2.4.0)
```python
# –ù–æ–≤—ã–π _seamless_blend_faces():
‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π (aspect ratio)
‚úÖ Poisson Blending (cv2.seamlessClone)
‚úÖ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è (mean + std)
‚úÖ Fallback –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—ã–π manual blend
‚úÖ Profile detection –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è —É–≥–ª–æ–≤
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: test_face_swapper.py

```bash
$ python test_face_swapper.py

================================================================================
–¢–ï–°–¢ –£–õ–£–ß–®–ï–ù–ù–û–ì–û FACE SWAPPER
================================================================================

‚úÖ FaceSwapper initialized
   Frontal cascade loaded: True
   Profile cascade loaded: True

üìÅ Base image: images\new_templates\figure_male1.png
üìÅ User photo: testphoto.jpg

üîÑ Performing face swap...
‚úÖ SUCCESS!
   Output: generated_photos\test_face_swap.jpg
   Size: 198.7 KB
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
- ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –û–±–∞ –∫–∞—Å–∫–∞–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞: –§–∞–π–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –†–∞–∑–º–µ—Ä: 198.7 KB (–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π)

---

## –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏

### Face Swapper vs Template Generator

**Face Swapper (`services/face_swapper.py`):**
- –ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –†–ï–ê–õ–¨–ù–´–ú–ò —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
- –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –ª–∏—Ü–∞ —á–µ—Ä–µ–∑ Haar Cascades
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç seamlessClone –¥–ª—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Å–º–µ—à–∏–≤–∞–Ω–∏—è
- **–ù–ï –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è 3D –º–æ–¥–µ–ª–µ–π** (–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ª–∏—Ü–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏)

**Template Generator (`services/template_generator.py`):**
- –†–∞–±–æ—Ç–∞–µ—Ç —Å 3D —à–∞–±–ª–æ–Ω–∞–º–∏ —Ñ–∏–≥—É—Ä–æ–∫
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã** –¥–ª—è –≥–æ–ª–æ–≤—ã
- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ñ–∏–≥—É—Ä–æ–∫ Pride34
- **–£–∂–µ —É–ª—É—á—à–µ–Ω –≤ v2.3.2** (4 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π:

```
–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ —Ñ–∏–≥—É—Ä–∫–∏ (—Ç–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç)
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: template_generator.py ‚úÖ

–°—Ü–µ–Ω–∞—Ä–∏–π 2: –§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + —Ñ–æ—Ç–æ –¥—Ä—É–≥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: face_swapper.py ‚úÖ

–°—Ü–µ–Ω–∞—Ä–∏–π 3: –§–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + 3D –º–æ–¥–µ–ª—å
‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å: template_generator.py ‚úÖ
```

---

## –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `services/face_swapper.py` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `test_face_swapper.py` - —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `FACE_SWAPPER_IMPROVEMENTS.md` - —ç—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```python
import cv2        # OpenCV –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
import numpy      # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞—Å—Å–∏–≤–∞–º–∏
from pathlib import Path
```

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã

**1. Haar Cascades (Face Detection):**
- `haarcascade_frontalface_default.xml` - —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏—Ü–∞
- `haarcascade_profileface.xml` - –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–µ –ª–∏—Ü–∞

**2. Poisson Blending (Seamless Cloning):**
- –ê–ª–≥–æ—Ä–∏—Ç–º: Gradient-domain editing
- –§—É–Ω–∫—Ü–∏—è: `cv2.seamlessClone(..., cv2.NORMAL_CLONE)`
- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Å–≤–µ—â–µ–Ω–∏—è

**3. LAB Color Matching:**
- –¶–≤–µ—Ç–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ: CIELAB
- –ö–æ—Ä—Ä–µ–∫—Ü–∏—è: Mean + Standard Deviation
- Fallback –¥–ª—è seamlessClone

---

## –î–µ–ø–ª–æ–π

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω: `python -m py_compile services/face_swapper.py`
‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç: `python test_face_swapper.py`
‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: SUCCESS (198.7 KB)

### Production
‚è≥ –û–∂–∏–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –¥–µ–ø–ª–æ–π

**–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è:**
```bash
scp services/face_swapper.py root@31.44.7.144:/var/www/pride34_gift_bot/services/
ssh root@31.44.7.144 "systemctl restart pride34-gift-bot"
```

---

## Changelog Entry

### [2.4.0] - 2025-12-29

#### –£–ª—É—á—à–µ–Ω–æ - services/face_swapper.py

**5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:**

1. **Padding —Ä–∞—Å—á—ë—Ç –≤ _extract_face_region()**
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –ø—Ä–∏ –ª–∏—Ü–µ —É –∫—Ä–∞—è
   - –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç x_start/y_start/x_end/y_end

2. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π –≤ _seamless_blend_faces()**
   - –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç aspect ratio
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ –∏—Å–∫–∞–∂–µ–Ω–∏–µ –ª–∏—Ü

3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è —Ü–≤–µ—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—è std (standard deviation)
   - –í–∑—è—Ç–æ –∏–∑ template_generator.py

4. **Profile detection**
   - –î–æ–±–∞–≤–ª–µ–Ω haarcascade_profileface.xml
   - Fallback –¥–ª—è –ª–∏—Ü –ø–æ–¥ —É–≥–ª–æ–º

5. **Seamless Cloning (Poisson Blending)**
   - –î–æ–±–∞–≤–ª–µ–Ω cv2.seamlessClone
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –æ—Å–≤–µ—â–µ–Ω–∏—è
   - Fallback –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω—ã–π manual blend

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
2. ‚è≥ –î–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä
3. ‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG.md
4. ‚è≥ Git commit + push

---

**–ê–≤—Ç–æ—Ä:** Claude Sonnet 4.5
**–î–∞—Ç–∞:** 2025-12-29
**–í–µ—Ä—Å–∏—è:** 2.4.0
